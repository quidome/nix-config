{ config, lib, pkgs, ... }:
let
  hyprlandEnabled = builtins.elem config.my.gui [ "hyprland" "sway" ];
in
{
  config = lib.mkIf hyprlandEnabled {
    systemd.user.sockets.dbus = {
      Unit = {
        Description = "D-Bus User Message Bus Socket";
      };
      Socket = {
        ListenStream = "%t/bus";
        ExecStartPost = "${pkgs.systemd}/bin/systemctl --user set-environment DBUS_SESSION_BUS_ADDRESS=unix:path=%t/bus";
      };
      Install = {
        WantedBy = [ "sockets.target" ];
        Also = [ "dbus.service" ];
      };
    };

    systemd.user.services.dbus = {
      Unit = {
        Description = "D-Bus User Message Bus";
        Requires = [ "dbus.socket" ];
      };
      Service = {
        ExecStart = "${pkgs.dbus}/bin/dbus-daemon --session --address=systemd: --nofork --nopidfile --systemd-activation";
        ExecReload = "${pkgs.dbus}/bin/dbus-send --print-reply --session --type=method_call --dest=org.freedesktop.DBus / org.freedesktop.DBus.ReloadConfig";
      };
      Install = {
        Also = [ "dbus.socket" ];
      };
    };
  };
}
